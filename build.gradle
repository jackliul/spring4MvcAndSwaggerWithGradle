apply plugin: 'java'
apply plugin: 'war'
apply plugin: 'maven'
apply plugin: 'org.akhikhl.gretty'
apply plugin: 'org.hidetake.ssh'
// apply from: rootProject.getRootDir().getAbsolutePath() + "/utils.gradle"

// https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html
// https://gradle-ssh-plugin.github.io/docs/
// https://www.linuxidc.com/Linux/2018-01/150211.htm

// https://my.oschina.net/u/2450739/blog/841462 虚拟机ping不通
// http://blog.csdn.net/wqc19920906/article/details/52608460?locationNum=10&fps=1

// TODO http://blog.csdn.net/fly910905/article/details/79131755 实现静态文档的生成

import org.apache.tools.ant.filters.ReplaceTokens

group 'com.jacliu.test'
version '1.0-SNAPSHOT'

sourceCompatibility = 1.8

ext{
    env = System.getProperty("env") ?: "dev"
}

tasks.withType(JavaCompile) {
	options.encoding = "UTF-8"
}
buildscript {  
  repositories {  
  	//jcenter()  
  	mavenCentral()
    maven {  
      url "http://maven.aliyun.com/nexus/content/groups/public/"
    }  
  } 
  dependencies {  
    classpath "gradle.plugin.org.akhikhl.gretty:gretty:2.0.0" 
    classpath 'org.hidetake:gradle-ssh-plugin:2.9.0'
    classpath 'org.codehaus.groovy:groovy-backports-compat23:2.4.6'
  }  
}  
repositories {
    mavenLocal()
    mavenCentral()
}
dependencies {
	providedRuntime 'javax.servlet:jstl:1.2'
	compile 'ch.qos.logback:logback-classic:1.1.3'
	compile 'org.springframework:spring-webmvc:4.1.6.RELEASE'
	compile 'org.apache.ant:ant:1.9.5'
	compile 'com.alibaba:druid:1.1.8'
	compile 'mysql:mysql-connector-java:5.1.42'
	compile 'io.springfox:springfox-swagger2:2.6.1'
	compile 'io.springfox:springfox-swagger-ui:2.6.1'
	compile 'com.drore.cloud:swagger-bootstrap-ui:1.4'
	compile 'com.fasterxml.jackson.core:jackson-core:2.5.1'
	compile 'com.fasterxml.jackson.core:jackson-databind:2.5.1'
	compile 'com.fasterxml.jackson.core:jackson-annotations:2.5.1'
	
	// https://mvnrepository.com/artifact/javax.servlet.jsp.jstl/jstl
	//compile group: 'javax.servlet.jsp.jstl', name: 'jstl', version: '1.2'
	
	// https://mvnrepository.com/artifact/javax.el/javax.el-api
	compile group: 'javax.el', name: 'javax.el-api', version: '3.0.0'
	
	// https://mvnrepository.com/artifact/org.hibernate.validator/hibernate-validator
	compile group: 'org.hibernate.validator', name: 'hibernate-validator', version: '6.0.8.Final'
}
	
sourceSets {
    main {
       java {  
            srcDirs "src/main/java"
        }  
        resources {
            srcDirs = ["src/main/resources"]
        }
    }
}

// 动态替换文件并打war包	gradle -Denv=pro build appRunDebug
def loadConfiguration() {
    def configFile = file('config.groovy') // 配置文件
    return new ConfigSlurper(env).parse(configFile.toURI().toURL()).toProperties()
}
processResources {
    from(sourceSets.main.resources.srcDirs) {
        // filter(ReplaceTokens, tokens: loadConfiguration())
        filter(ReplaceTokens, tokens: loadConfiguration(), beginToken : '${', endToken : '}')
    }
}
war{  
    webInf { from 'build/resources/main' }
    archiveName 'spring4MvcAndSwaggerWithGradle.war'
}  

// 远程上传到服务器上
ssh.settings {  
  knownHosts = allowAnyHosts  
}  
remotes {  
  deployServer {  
    role 'masterNode'
    host = '192.168.0.157'  
    user = 'root'  
    password = '12345678'  
  }  
}  

task uploadInstallJdk() << {
	ssh.run {  
	    session(remotes.deployServer) { 
	         executeScript '''
      					#!/bin/sh  
                        rm -rf /home/tomcatHome
                        mkdir /home/tomcatHome
                    '''  
		      put from: "D:/downLoad/apache-tomcat-8.5.29.tar.gz", into: "/home/tomcatHome"
		      executeScript '''
		      			#!/bin/sh
		      			tar -zxvf /home/tomcatHome/apache-tomcat-8.5.29.tar.gz -C /home/tomcatHome/
		      			mv /home/tomcatHome/apache-tomcat-8.5.29 /home/tomcatHome/tomcat8
		      			rm -rf /home/tomcatHome/apache-tomcat-8.5.29.tar.gz
		      		'''
	    }
	}
}

task uploadInstallTomcat() << {
	ssh.run {  
	    session(remotes.deployServer) { 
	         executeScript '''
      					#!/bin/sh  
                        rm -rf /home/tomcatHome
                        mkdir /home/tomcatHome
                    '''  
		      put from: "D:/downLoad/apache-tomcat-8.5.29.tar.gz", into: "/home/tomcatHome"
		      executeScript '''
		      			#!/bin/sh
		      			tar -zxvf /home/tomcatHome/apache-tomcat-8.5.29.tar.gz -C /home/tomcatHome/
		      			mv /home/tomcatHome/apache-tomcat-8.5.29 /home/tomcatHome/tomcat8
		      			rm -rf /home/tomcatHome/apache-tomcat-8.5.29.tar.gz
		      		'''
	    }
	}
}


task deploy() << {  
  ssh.run {  
    session(remotes.deployServer) {  
        execute '/home/tomcatHome/tomcat8/bin/shutdown.sh'
    	remove '/home/tomcatHome/tomcat8/webapps/spring4MvcAndSwaggerWithGradle','/home/tomcatHome/tomcat8/webapps/spring4MvcAndSwaggerWithGradle.war'
		put from: buildDir.toString() + '/libs/spring4MvcAndSwaggerWithGradle.war', into: '/home/tomcatHome/tomcat8/webapps'
		execute '/home/tomcatHome/tomcat8/bin/startup.sh'  
    }  
  }  
}
project.afterEvaluate{  
  tasks.getByName("war"){  
       it.doFirst{  
       }  
       
       it.doLast{  
       }  
    }  
}

gretty {
    httpPort = 8089
	managedClassReload = true
	reloadOnConfigChange = true
    contextPath = '/'
    
    //recompileOnSourceChange = false
    //reloadOnClassChange = false
    //reloadOnLibChange = false
}
	
// 扩展上传到maven的插件	
uploadArchives {
	repositories.mavenDeployer {
	    repository(url: "http://localhost:8088/nexus/content/repositories/snapshots/") {
	        authentication(userName: "admin", password: "admin123")
	        pom.groupId = "com.juvenxu"
	        pom.artifactId = "account-captcha"
        }
    }
}